def PIPELINE_ID = "${env.BUILD_NUMBER}"

def getImageTag() {
    def dateFormat = new java.text.SimpleDateFormat('yyyyMMddHHmmss')
    def currentDate = new Date()
    return dateFormat.format(currentDate)
}

podTemplate(
    label: "${PIPELINE_ID}",
    serviceAccount: 'jenkins',
    slaveConnectTimeout: 300,
    idleMinutes: 1,
    activeDeadlineSeconds: 3600,
    podRetention: never(),  // 파드 자동 정리 옵션: never(), onFailure(), always(), default()
    yaml: '''
        spec:
          terminationGracePeriodSeconds: 3
          restartPolicy: Never
          tolerations:
          - effect: NoSchedule
            key: dedicated
            operator: Equal
            value: cicd
    ''',
    containers: [
        containerTemplate(
            name: 'podman',
            image: "mgoltzsche/podman",
            ttyEnabled: true,
            command: 'cat',
            privileged: true,
            resourceRequestCpu: '500m',
            resourceRequestMemory: '2Gi',
            resourceLimitCpu: '2000m',
            resourceLimitMemory: '4Gi'
        ),
        containerTemplate(
            name: 'gradle',
            image: 'gradle:jdk21',
            ttyEnabled: true,
            command: 'cat',
            resourceRequestCpu: '500m',
            resourceRequestMemory: '1Gi',
            resourceLimitCpu: '1000m',
            resourceLimitMemory: '2Gi',
            envVars: [
                envVar(key: 'DOCKER_HOST', value: 'unix:///run/podman/podman.sock'),
                envVar(key: 'TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE', value: '/run/podman/podman.sock'),
                envVar(key: 'TESTCONTAINERS_RYUK_DISABLED', value: 'true')
            ]
        ),
        containerTemplate(
            name: 'azure-cli',
            image: 'hiondal/azure-kubectl:latest',
            command: 'cat',
            ttyEnabled: true,
            resourceRequestCpu: '200m',
            resourceRequestMemory: '512Mi',
            resourceLimitCpu: '500m',
            resourceLimitMemory: '1Gi'
        ),
        containerTemplate(
            name: 'git',
            image: 'alpine/git:latest',
            command: 'cat',
            ttyEnabled: true,
            resourceRequestCpu: '100m',
            resourceRequestMemory: '256Mi',
            resourceLimitCpu: '300m',
            resourceLimitMemory: '512Mi'
        )
    ],
    volumes: [
        emptyDirVolume(mountPath: '/home/gradle/.gradle', memory: false),
        emptyDirVolume(mountPath: '/root/.azure', memory: false),
        emptyDirVolume(mountPath: '/run/podman', memory: false)
    ]
) {
    node(PIPELINE_ID) {
        def props
        // def imageTag = getImageTag()
        def imageTag = 'dg0515'
        def environment = params.ENVIRONMENT ?: 'dev'
        def skipSonarQube = (params.SKIP_SONARQUBE?.toLowerCase() == 'true')
        def services = ['api-gateway', 'user-service', 'bill-service', 'product-service', 'kos-mock']

        try {
            stage("Get Source") {
                checkout scm
                props = readProperties file: "deployment/cicd/config/deploy_env_vars_${environment}"
            }

            stage("Setup AKS") {
                container('azure-cli') {
                    withCredentials([azureServicePrincipal('azure-credentials')]) {
                        sh """
                            az login --service-principal -u \$AZURE_CLIENT_ID -p \$AZURE_CLIENT_SECRET -t \$AZURE_TENANT_ID
                            az aks get-credentials --resource-group ${props.resource_group} --name ${props.cluster_name} --overwrite-existing
                            kubectl create namespace phonebill-dg0515 --dry-run=client -o yaml | kubectl apply -f -
                        """
                    }
                }
            }

            stage('Build') {
                container('gradle') {
                    sh """
                        chmod +x gradlew
                        ./gradlew build -x test
                    """
                }
            }

            stage('SonarQube Analysis & Quality Gate') {
                if (skipSonarQube) {
                    echo "⏭️ Skipping SonarQube Analysis (SKIP_SONARQUBE=${params.SKIP_SONARQUBE})"
                } else {
                    container('gradle') {
                        // 각 서비스별로 개별적으로 SonarQube 분석 및 Quality Gate 확인
                        services.each { service ->
                            withSonarQubeEnv('SonarQube') {
                                echo "🔍 Starting SonarQube analysis for ${service}..."

                                // 서비스별 테스트 및 SonarQube 분석
                                sh """
                                    ./gradlew :${service}:test :${service}:jacocoTestReport :${service}:sonar \\
                                        -Dsonar.projectKey=phonebill-${service}-dg0515 \\
                                        -Dsonar.projectName=phonebill-${service}-dg0515 \\
                                        -Dsonar.java.binaries=build/classes/java/main \\
                                        -Dsonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml \\
                                        -Dsonar.exclusions=**/config/**,**/entity/**,**/dto/**,**/*Application.class,**/exception/**
                                """

                                echo "✅ SonarQube analysis completed for ${service}"
                            }

                            // 각 서비스별 Quality Gate 확인
                            timeout(time: 5, unit: 'MINUTES') {
                                echo "⏳ Waiting for Quality Gate result for ${service}..."
                                def qg = waitForQualityGate()
                                if (qg.status != 'OK') {
                                    error "❌ Quality Gate failed for ${service}: ${qg.status}"
                                } else {
                                    echo "✅ Quality Gate passed for ${service}"
                                }
                            }
                        }

                        echo "🎉 All services passed SonarQube Quality Gates!"
                    }
                }
            }

            stage('Build & Push Images') {
                timeout(time: 30, unit: 'MINUTES') {
                    container('podman') {
                        withCredentials([
                            usernamePassword(
                                credentialsId: 'acr-credentials',
                                usernameVariable: 'ACR_USERNAME',
                                passwordVariable: 'ACR_PASSWORD'
                            ),
                            usernamePassword(
                                credentialsId: 'dockerhub-credentials',
                                usernameVariable: 'DOCKERHUB_USERNAME',
                                passwordVariable: 'DOCKERHUB_PASSWORD'
                            )
                        ]) {
                            // Docker Hub 로그인 (rate limit 해결)
                            sh "podman login docker.io --username \$DOCKERHUB_USERNAME --password \$DOCKERHUB_PASSWORD"

                            // ACR 로그인
                            sh "podman login acrdigitalgarage03.azurecr.io --username \$ACR_USERNAME --password \$ACR_PASSWORD"

                            services.each { service ->
                                sh """
                                    podman build \\
                                        --build-arg BUILD_LIB_DIR="${service}/build/libs" \\
                                        --build-arg ARTIFACTORY_FILE="${service}.jar" \\
                                        -f deployment/container/Dockerfile-backend \\
                                        -t acrdigitalgarage03.azurecr.io/phonebill/${service}:${environment}-${imageTag} .

                                    podman push acrdigitalgarage03.azurecr.io/phonebill/${service}:${environment}-${imageTag}
                                """
                            }
                        }
                    }
                }
            }

            stage('Update Manifest Repository') {
                container('git') {
                    withCredentials([usernamePassword(
                        credentialsId: 'github-credentials-dg0515',
                        usernameVariable: 'GIT_USERNAME',
                        passwordVariable: 'GIT_TOKEN'
                    )]) {
                        sh """
                            # 매니페스트 레포지토리 클론
                            REPO_URL=\$(echo "https://github.com/Minseo-Jo/phonebill.git" | sed 's|https://||')
                            git clone https://\${GIT_USERNAME}:\${GIT_TOKEN}@\${REPO_URL} manifest-repo
                            cd manifest-repo

                            # Kustomize 설치
                            curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
                            mkdir -p \$HOME/bin && mv kustomize \$HOME/bin/
                            export PATH=\$PATH:\$HOME/bin

                            # 환경별 매니페스트 업데이트
                            cd deployment/cicd/kustomize/overlays/${environment}

                            # 각 서비스별 이미지 태그 업데이트
                            services="api-gateway user-service bill-service product-service kos-mock"
                            for service in \$services; do
                                \$HOME/bin/kustomize edit set image acrdigitalgarage03.azurecr.io/phonebill/\$service:${environment}-${imageTag}
                            done

                            # Git 설정 및 푸시
                            cd ../../../../..
                            git config user.name "Jenkins CI"
                            git config user.email "jenkins@example.com"
                            git add .
                            git commit -m "🚀 Update phonebill ${environment} images to ${environment}-${imageTag}"
                            git push origin main

                            echo "✅ 매니페스트 업데이트 완료. ArgoCD가 자동으로 배포합니다."
                        """
                    }
                }
            }

            // 파이프라인 완료 로그 (Scripted Pipeline 방식)
            stage('Pipeline Complete') {
                echo "🧹 Pipeline completed. Pod cleanup handled by Jenkins Kubernetes Plugin."

                // 성공/실패 여부 로깅
                if (currentBuild.result == null || currentBuild.result == 'SUCCESS') {
                    echo "✅ Pipeline completed successfully!"
                } else {
                    echo "❌ Pipeline failed with result: ${currentBuild.result}"
                }
            }

        } catch (Exception e) {
            currentBuild.result = 'FAILURE'
            echo "❌ Pipeline failed with exception: ${e.getMessage()}"
            throw e
        } finally {
            echo "🧹 Cleaning up resources and preparing for pod termination..."
            echo "Pod will be terminated in 3 seconds due to terminationGracePeriodSeconds: 3"
        }
    }
}
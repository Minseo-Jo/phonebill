name: Backend CI/CD Pipeline with ArgoCD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'api-gateway/**'
      - 'user-service/**'
      - 'bill-service/**'
      - 'product-service/**'
      - 'kos-mock/**'
      - 'common/**'
      - '.github/workflows/backend-cicd_ArgoCD.yaml'
  pull_request:
    branches: [ main ]
    paths:
      - 'api-gateway/**'
      - 'user-service/**'
      - 'bill-service/**'
      - 'product-service/**'
      - 'kos-mock/**'
      - 'common/**'

env:
  ACR_NAME: acrdigitalgarage03
  RESOURCE_GROUP: rg-digitalgarage-03
  AKS_CLUSTER: aks-digitalgarage-03
  NAMESPACE: phonebill-dg0515
  SYSTEM_NAME: phonebill
  MANIFEST_REPO_URL: https://github.com/Minseo-Jo/phonebill.git
  SERVICE_NAMES: "api-gateway user-service bill-service product-service kos-mock"

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      environment: ${{ steps.meta.outputs.environment }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: ~/.gradle/caches
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
        restore-keys: ${{ runner.os }}-gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Set image metadata
      id: meta
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        if [ "$BRANCH_NAME" = "main" ]; then
          ENVIRONMENT="prod"
        elif [ "$BRANCH_NAME" = "develop" ]; then
          ENVIRONMENT="dev"
        else
          ENVIRONMENT="staging"
        fi

        IMAGE_TAG=${GITHUB_SHA::7}-$(date +%Y%m%d%H%M%S)

        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "Environment: $ENVIRONMENT"
        echo "Image Tag: $IMAGE_TAG"

    - name: Build with Gradle
      run: |
        ./gradlew clean build -x test
        echo "âœ… Build completed successfully"

    - name: Run Tests
      run: |
        ./gradlew test
        echo "âœ… Tests completed successfully"

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: ~/.gradle/caches
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
        restore-keys: ${{ runner.os }}-gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build JAR files
      run: |
        ./gradlew clean build -x test
        echo "âœ… JAR build completed"

    - name: Azure Container Registry Login
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.ACR_NAME }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Build and Push Docker Images
      run: |
        ENVIRONMENT=${{ needs.build.outputs.environment }}
        IMAGE_TAG=${{ needs.build.outputs.image_tag }}

        # ê° ì„œë¹„ìŠ¤ë³„ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        for service in ${{ env.SERVICE_NAMES }}; do
          echo "ğŸ”¨ Building $service image..."

          # Dockerfile ê²½ë¡œ í™•ì¸
          if [ -f "$service/Dockerfile" ]; then
            DOCKERFILE_PATH="$service/Dockerfile"
          else
            echo "âŒ Dockerfile not found for $service"
            continue
          fi

          # ì´ë¯¸ì§€ ë¹Œë“œ
          docker build \
            -f $DOCKERFILE_PATH \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.SYSTEM_NAME }}/$service:$ENVIRONMENT-$IMAGE_TAG \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.SYSTEM_NAME }}/$service:latest \
            .

          # ì´ë¯¸ì§€ í‘¸ì‹œ
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.SYSTEM_NAME }}/$service:$ENVIRONMENT-$IMAGE_TAG
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.SYSTEM_NAME }}/$service:latest

          echo "âœ… $service image pushed successfully"
        done

  update-manifest:
    name: Update Manifest Repository
    needs: [build, release]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - name: Set image tag environment variable
      run: |
        echo "IMAGE_TAG=${{ needs.build.outputs.image_tag }}" >> $GITHUB_ENV
        echo "ENVIRONMENT=${{ needs.build.outputs.environment }}" >> $GITHUB_ENV

    - name: Update Manifest Repository
      run: |
        # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë ˆí¬ì§€í† ë¦¬ í´ë¡ 
        REPO_URL=$(echo "${{ env.MANIFEST_REPO_URL }}" | sed 's|https://||')
        git clone https://${{ secrets.GIT_USERNAME }}:${{ secrets.GIT_PASSWORD }}@${REPO_URL} manifest-repo
        cd manifest-repo

        # Kustomize ì„¤ì¹˜
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/

        # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ deployment/cicd ê²½ë¡œ ì‚¬ìš©)
        cd deployment/cicd/kustomize/overlays/${{ env.ENVIRONMENT }}

        # ê° ì„œë¹„ìŠ¤ë³„ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
        services="${{ env.SERVICE_NAMES }}"
        for service in $services; do
          kustomize edit set image ${{ env.ACR_NAME }}.azurecr.io/${{ env.SYSTEM_NAME }}/$service:${{ env.ENVIRONMENT }}-${{ env.IMAGE_TAG }}
        done

        # Git ì„¤ì • ë° í‘¸ì‹œ
        cd ../../../../..
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git commit -m "ğŸš€ Update ${{ env.SYSTEM_NAME }} ${{ env.ENVIRONMENT }} images to ${{ env.ENVIRONMENT }}-${{ env.IMAGE_TAG }}"
        git push origin main

        echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ. ArgoCDê°€ ìë™ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤."